<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi ဝန်ဆောင်မှု စီမံခန့်ခွဲမှု</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- XLSX library for Excel download -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.0/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
        }
        .warning-light {
            width: 1rem;
            height: 1rem;
            border-radius: 9999px;
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .warning-green {
            background-color: #34d399;
            box-shadow: 0 0 8px #34d399;
        }
        .warning-yellow {
            background-color: #fcd34d;
            box-shadow: 0 0 8px #fcd34d;
        }
        .warning-red {
            background-color: #f87171;
            box-shadow: 0 0 8px #f87171;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="p-4 sm:p-8 bg-gray-100 min-h-screen flex flex-col items-center">

    <!-- Login Container -->
    <div id="loginContainer" class="bg-white rounded-xl shadow-2xl p-6 sm:p-10 w-full max-w-md flex flex-col items-center justify-center space-y-6">
        <h1 class="text-3xl font-bold text-gray-800">Login ဝင်ရန်</h1>
        <p class="text-gray-600 text-center">Dashboad ကို ဆက်လက်ကြည့်ရှုရန် အသုံးပြုသူအမည်နှင့် လျှို့ဝှက်နံပါတ်ဖြည့်ပါ</p>
        <form id="loginForm" class="w-full space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">အသုံးပြုသူအမည်</label>
                <input type="text" id="username" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">လျှို့ဝှက်နံပါတ်</label>
                <input type="password" id="password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3">
            </div>
            <p id="loginStatusMessage" class="text-red-500 text-sm hidden"></p>
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md shadow-lg transition-colors">
                Login
            </button>
        </form>
    </div>

    <!-- Main Content Container -->
    <div id="mainContent" class="bg-white rounded-xl shadow-2xl p-6 sm:p-10 w-full max-w-6xl space-y-12 hidden">
        <header class="flex flex-col sm:flex-row items-center justify-between mb-8 pb-4 border-b">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">WiFi ဝန်ဆောင်မှု Dashboad</h1>
            <div class="mt-2 sm:mt-0 text-sm text-gray-600">
                <span id="userIdDisplay"></span>
            </div>
        </header>

        <!-- Summary & Key Metrics Section -->
        <section id="summary-metrics" class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700">အကျဉ်းချုပ် အချက်အလက်များ</h2>
            <p class="text-gray-600">
                ဒီအပိုင်းမှာ သင့်ရဲ့ WiFi ဝန်ဆောင်မှုလုပ်ငန်းရဲ့ အဓိကအချက်အလက်များကို အမြန်ဆုံး ကြည့်ရှုနိုင်ပါတယ်။
                စုစုပေါင်း ကျသင့်ငွေ၊ လက်ရှိလက်ခံရရှိငွေ၊ နဲ့ ကျန်ရှိနေသေးတဲ့ ငွေပမာဏများကို ရှင်းရှင်းလင်းလင်းပြသထားပါတယ်။
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div class="bg-indigo-50 rounded-xl p-6 shadow-md">
                    <p class="text-sm font-medium text-gray-500">စုစုပေါင်း ကျသင့်ငွေ</p>
                    <p id="totalAmountSum" class="mt-2 text-3xl font-bold text-indigo-600">0</p>
                </div>
                <div class="bg-green-50 rounded-xl p-6 shadow-md">
                    <p class="text-sm font-medium text-gray-500">ပေးချေထားသော စုစုပေါင်းငွေ</p>
                    <p id="paidAmountSum" class="mt-2 text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-red-50 rounded-xl p-6 shadow-md">
                    <p class="text-sm font-medium text-gray-500">ပေးရန် ကျန်ရှိသော စုစုပေါင်းငွေ</p>
                    <p id="remainingAmountSum" class="mt-2 text-3xl font-bold text-red-600">0</p>
                </div>
            </div>
        </section>

        <!-- Detailed User Breakdown Section -->
        <section id="user-details" class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700">အသုံးပြုသူ အသေးစိတ်</h2>
            <p class="text-gray-600">
                ဤဇယားတွင် အသုံးပြုသူ တစ်ဦးချင်းစီ၏ အချက်အလက်များ၊ သက်တမ်းကုန်ဆုံးရက်နှင့် ကျန်ရှိငွေများကို အလွယ်တကူရှာဖွေကြည့်ရှုနိုင်ပါတယ်။
                အမည်ကိုရိုက်ထည့်ပြီး အလိုရှိရာအသုံးပြုသူကို အမြန်ဆုံး ရှာဖွေနိုင်ပါသည်။
            </p>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="searchBar" placeholder="အမည်ဖြင့် ရှာဖွေပါ..." class="w-full p-3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <button onclick="downloadExcel()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-colors whitespace-nowrap">
                    Excel အဖြစ် Download လုပ်ရန်
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">နံပါတ်</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">အမည်</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">စတင်ရက်</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">သက်တမ်းကုန်ဆုံးရက်</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ကျန်ရှိငွေ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">သတိပေးချက်</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">လုပ်ဆောင်ချက်</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Interactive Data Charts Section -->
        <section id="data-charts" class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700">အချက်အလက်ဇယားများ</h2>
            <p class="text-gray-600">
                အသုံးပြုသူများ၏ အချက်အလက်အသုံးပြုမှုနှင့် ငွေပေးချေမှုအခြေအနေများကို ပုံစံမျိုးစုံဖြင့် ကြည့်ရှုနိုင်ပါတယ်။
                ဒီဇယားများဟာ အချက်အလက်အသစ်တွေထည့်လိုက်တာနဲ့ အလိုအလျောက် ပြောင်းလဲသွားပါလိမ့်မယ်။
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl p-6 shadow-md flex flex-col justify-center items-center">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">အသုံးပြုထားသည့် Speed MB</h3>
                    <div class="chart-container">
                        <canvas id="mbUsageChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-md flex flex-col justify-center items-center">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">ကျန်ရှိငွေ အချိုးအစား</h3>
                    <div class="chart-container">
                        <canvas id="paymentStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Add/Edit User Form -->
        <form id="userForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-lg shadow-inner">
            <h2 id="formTitle" class="col-span-full text-xl font-semibold text-gray-700 mb-2">အသုံးပြုသူ အသစ်ထည့်ရန်</h2>
            <input type="hidden" id="docId">
            <div class="col-span-1">
                <label for="userNameInput" class="block text-sm font-medium text-gray-700">အမည်</label>
                <input type="text" id="userNameInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div class="col-span-1">
                <label for="userStartDateInput" class="block text-sm font-medium text-gray-700">စတင်ရက်</label>
                <input type="date" id="userStartDateInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div class="col-span-1">
                <label for="userEndDateInput" class="block text-sm font-medium text-gray-700">သက်တမ်းကုန်ဆုံးရက်</label>
                <input type="date" id="userEndDateInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div class="col-span-1">
                <label for="mbUsedInput" class="block text-sm font-medium text-gray-700">အသုံးပြုထားသည့် MB ပမာဏ</label>
                <input type="number" id="mbUsedInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div class="col-span-1">
                <label for="totalAmountInput" class="block text-sm font-medium text-gray-700">ကျသင့်ငွေ</label>
                <input type="number" id="totalAmountInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div class="col-span-1">
                <label for="paidAmountInput" class="block text-sm font-medium text-gray-700">ပေးချေထားသောငွေ</label>
                <input type="number" id="paidAmountInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div class="col-span-1 flex items-end">
                <button type="submit" id="formSubmitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-colors">
                    အသုံးပြုသူ အသစ်ထည့်ရန်
                </button>
            </div>
        </form>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM elements
        const loginContainer = document.getElementById('loginContainer');
        const loginForm = document.getElementById('loginForm');
        const loginStatusMessage = document.getElementById('loginStatusMessage');
        const mainContent = document.getElementById('mainContent');

        const userForm = document.getElementById('userForm');
        const userTableBody = document.getElementById('userTableBody');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const searchBar = document.getElementById('searchBar');
        const totalAmountSumEl = document.getElementById('totalAmountSum');
        const paidAmountSumEl = document.getElementById('paidAmountSum');
        const remainingAmountSumEl = document.getElementById('remainingAmountSum');
        const mbUsageChartCtx = document.getElementById('mbUsageChart').getContext('2d');
        const paymentStatusChartCtx = document.getElementById('paymentStatusChart').getContext('2d');
        const formTitle = document.getElementById('formTitle');
        const formSubmitButton = document.getElementById('formSubmitButton');
        const docIdInput = document.getElementById('docId');

        // New unique IDs for the user form
        const userNameInput = document.getElementById('userNameInput');
        const userStartDateInput = document.getElementById('userStartDateInput');
        const userEndDateInput = document.getElementById('userEndDateInput');
        const mbUsedInput = document.getElementById('mbUsedInput');
        const totalAmountInput = document.getElementById('totalAmountInput');
        const paidAmountInput = document.getElementById('paidAmountInput');


        // Global variables for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let allUsers = [];
        let mbUsageChart, paymentStatusChart;

        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Custom message box to replace alert()
        const showMessage = (message, isError = false) => {
            const messageBox = document.createElement('div');
            messageBox.innerText = message;
            messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            document.body.appendChild(messageBox);
            setTimeout(() => {
                messageBox.remove();
            }, 3000);
        };

        // Initialize and configure charts
        const initCharts = () => {
            // Destroy existing charts before creating new ones
            if (mbUsageChart) {
                mbUsageChart.destroy();
            }
            if (paymentStatusChart) {
                paymentStatusChart.destroy();
            }

            const baseChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                }
            };

            // Options for the MB Usage Chart (Bar Chart)
            const mbUsageChartOptions = {
                ...baseChartOptions,
                plugins: {
                    ...baseChartOptions.plugins,
                    tooltip: {
                        callbacks: {
                            label: (tooltipItem) => {
                                const label = tooltipItem.dataset.label || '';
                                const value = tooltipItem.parsed.y;
                                return `${label}: ${value} MB`;
                            }
                        }
                    }
                }
            };

            // Options for the Payment Status Chart (Doughnut Chart)
            const paymentStatusChartOptions = {
                ...baseChartOptions,
                plugins: {
                    ...baseChartOptions.plugins,
                    tooltip: {
                        callbacks: {
                            label: (tooltipItem) => {
                                const label = tooltipItem.label || '';
                                const value = tooltipItem.parsed;
                                return `${label}: ${value.toLocaleString()} ကျပ်`;
                            }
                        }
                    }
                }
            };

            mbUsageChart = new Chart(mbUsageChartCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Speed MB',
                        data: [],
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: mbUsageChartOptions
            });

            paymentStatusChart = new Chart(paymentStatusChartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ပေးချေပြီး', 'ပေးရန်ကျန်'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#10b981', '#f87171'],
                        hoverOffset: 4
                    }]
                },
                options: paymentStatusChartOptions
            });
        };

        // Update charts with new data
        const updateCharts = () => {
            const userLabels = allUsers.map(user => user.username.split(' ').map(word => {
                if (word.length > 16) {
                    return word.slice(0, 13) + '...';
                }
                return word;
            }).join(' '));
            const mbData = allUsers.map(user => user.mbUsed);
            mbUsageChart.data.labels = userLabels;
            mbUsageChart.data.datasets[0].data = mbData;
            mbUsageChart.update();

            const totalPaid = allUsers.reduce((sum, user) => sum + user.paidAmount, 0);
            const totalRemaining = allUsers.reduce((sum, user) => sum + (user.totalAmount - user.paidAmount), 0);
            paymentStatusChart.data.datasets[0].data = [totalPaid, totalRemaining];
            paymentStatusChart.update();
        };

        // Update summary metrics
        const updateSummaryMetrics = () => {
            const totalAmountSum = allUsers.reduce((sum, user) => sum + user.totalAmount, 0);
            const paidAmountSum = allUsers.reduce((sum, user) => sum + user.paidAmount, 0);
            const remainingAmountSum = totalAmountSum - paidAmountSum;
            totalAmountSumEl.innerText = `${totalAmountSum.toLocaleString()} ကျပ်`;
            paidAmountSumEl.innerText = `${paidAmountSum.toLocaleString()} ကျပ်`;
            remainingAmountSumEl.innerText = `${remainingAmountSum.toLocaleString()} ကျပ်`;
        };

        // Initialize the main application after successful login
        const initApp = (user) => {
            initCharts();
            const userId = user.uid;
            userIdDisplay.innerText = `အသုံးပြုသူ ID: ${userId}`;
            const usersCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/wifi_users`);
            
            // Listen for real-time changes in the database
            onSnapshot(usersCollectionRef, (snapshot) => {
                allUsers = [];
                snapshot.forEach(doc => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });
                filterAndRenderUsers(searchBar.value);
                updateSummaryMetrics();
                updateCharts();
            }, (error) => {
                console.error("Error getting user data:", error);
            });
            
            // Add/Edit user form submission handler
            userForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // ဒါက စာမျက်နှာ Reload မဖြစ်အောင် တားဆီးပေးပါတယ်။
                const docId = docIdInput.value;
                const userData = {
                    username: userNameInput.value,
                    startDate: userStartDateInput.value,
                    endDate: userEndDateInput.value,
                    mbUsed: parseInt(mbUsedInput.value),
                    totalAmount: parseInt(totalAmountInput.value),
                    paidAmount: parseInt(paidAmountInput.value),
                };

                try {
                    if (docId) {
                        // Update existing user
                        const userRef = doc(db, `/artifacts/${appId}/users/${userId}/wifi_users`, docId);
                        await setDoc(userRef, userData);
                        showMessage("အသုံးပြုသူအချက်အလက် အောင်မြင်စွာ ပြင်ဆင်ပြီးပါပြီ။");
                    } else {
                        // Add new user
                        await addDoc(usersCollectionRef, userData);
                        showMessage("အသုံးပြုသူအသစ် အောင်မြင်စွာ ထည့်သွင်းပြီးပါပြီ။");
                    }
                    userForm.reset();
                    docIdInput.value = ''; // Clear docId
                    formTitle.innerText = 'အသုံးပြုသူ အသစ်ထည့်ရန်';
                    formSubmitButton.innerText = 'အသုံးပြုသူ အသစ်ထည့်ရန်';
                } catch (error) {
                    console.error("Error saving document:", error);
                    showMessage("အချက်အလက် သိမ်းဆည်းရာတွင် အမှားအယွင်းဖြစ်ပေါ်ခဲ့ပါသည်။", true);
                }
            });
            
            // Search bar functionality
            searchBar.addEventListener('keyup', (e) => {
                filterAndRenderUsers(e.target.value);
            });
        };

        // Edit user function
        window.editUser = (docId) => {
            const userToEdit = allUsers.find(user => user.id === docId);
            if (userToEdit) {
                docIdInput.value = userToEdit.id;
                userNameInput.value = userToEdit.username;
                userStartDateInput.value = userToEdit.startDate;
                userEndDateInput.value = userToEdit.endDate;
                mbUsedInput.value = userToEdit.mbUsed;
                totalAmountInput.value = userToEdit.totalAmount;
                paidAmountInput.value = userToEdit.paidAmount;
                
                formTitle.innerText = 'အသုံးပြုသူ အချက်အလက် ပြင်ဆင်ရန်';
                formSubmitButton.innerText = 'အချက်အလက် ပြင်ဆင်ရန်';
            }
        };

        // Delete user function
        window.deleteUser = async (docId) => {
            try {
                const userId = auth.currentUser.uid;
                const userRef = doc(db, `/artifacts/${appId}/users/${userId}/wifi_users`, docId);
                await deleteDoc(userRef);
                showMessage("အသုံးပြုသူကို အောင်မြင်စွာ ဖျက်လိုက်ပါပြီ။");
            } catch (error) {
                console.error("Error deleting document:", error);
                showMessage("ဖျက်ရာတွင် အမှားအယွင်းဖြစ်ပေါ်ခဲ့ပါသည်။", true);
            }
        };

        // Filter and render users based on search query
        const filterAndRenderUsers = (query) => {
            const lowerCaseQuery = query.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(lowerCaseQuery)
            );
            renderUsers(filteredUsers);
        };

        // Render the user table
        const renderUsers = (users) => {
            userTableBody.innerHTML = '';
            const today = new Date();
            users.forEach((user, index) => {
                const row = document.createElement('tr');
                const endDate = new Date(user.endDate);
                const oneDayInMs = 24 * 60 * 60 * 1000;
                const timeDiff = endDate.getTime() - today.getTime();
                const timeDiffDays = Math.ceil(timeDiff / oneDayInMs);
                let warningClass = '';
                if (timeDiffDays <= 7) {
                    warningClass = 'warning-red';
                } else if (timeDiffDays <= 15) {
                    warningClass = 'warning-yellow';
                } else if (timeDiffDays <= 30) {
                    warningClass = 'warning-green';
                }
                const remainingAmount = user.totalAmount - user.paidAmount;
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${user.username}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${user.startDate}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${user.endDate}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${remainingAmount.toLocaleString()} ကျပ်</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="warning-light ${warningClass}"></div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editUser('${user.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">ပြင်ဆင်ရန်</button>
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">ဖျက်ရန်</button>
                    </td>
                `;
                userTableBody.appendChild(row);
            });
        };

        // Function to handle the Excel download
        function downloadExcel() {
            if (allUsers.length === 0) {
                showMessage("Download လုပ်ရန် အချက်အလက်မရှိပါ။", true);
                return;
            }

            // Create data in the same format as the table
            const data = [
                ["နံပါတ်", "အမည်", "စတင်ရက်", "သက်တမ်းကုန်ဆုံးရက်", "ကျန်ရှိငွေ", "အသုံးပြုထားသည့် MB"]
            ];

            allUsers.forEach((user, index) => {
                const remainingAmount = user.totalAmount - user.paidAmount;
                data.push([
                    index + 1,
                    user.username,
                    user.startDate,
                    user.endDate,
                    remainingAmount,
                    user.mbUsed
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "အသုံးပြုသူစာရင်း");
            XLSX.writeFile(wb, "wifi_users_report.xlsx");

            showMessage("Excel ကို အောင်မြင်စွာ Download လုပ်ပြီးပါပြီ။");
        }

        window.downloadExcel = downloadExcel;

        // Login form submission handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // ဒါက စာမျက်နှာ Reload မဖြစ်အောင် တားဆီးပေးပါတယ်။
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;

            if (usernameInput === 'wifiservice' && passwordInput === 'wifiservice') {
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .catch((error) => {
                            console.error("Error signing in with custom token, attempting anonymous sign-in:", error);
                            signInAnonymously(auth).catch((err) => {
                                console.error("Anonymous sign-in failed:", err);
                            });
                        });
                } else {
                    signInAnonymously(auth)
                        .catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                        });
                }
            } else {
                loginStatusMessage.innerText = "အသုံးပြုသူအမည် သို့မဟုတ် လျှို့ဝှက်နံပါတ် မှားယွင်းနေပါသည်။";
                loginStatusMessage.classList.remove('hidden');
            }
        });

        // Initialize charts and listen for auth state change on page load
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in.
                loginContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');
                initApp(user);
            } else {
                // User is signed out.
                loginContainer.classList.remove('hidden');
                mainContent.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
